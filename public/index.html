<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ•ã‚©ãƒ“ã‚¢ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£ - ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒ¼ãƒªãƒ¼</title>
  <style>
    body {
      margin: 0;
      background: url('bg.jpg') no-repeat center center / cover;
      font-family: "Helvetica Neue", sans-serif;
    }

    #titleScreen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: rgba(229, 221, 213, 0.9);
    }

    #titleScreen h1 {
      font-size: 32px;
      margin-bottom: 20px;
    }

    #titleScreen button {
      margin: 10px;
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 25px;
      border: none;
      background-color: #128C7E;
      color: white;
      cursor: pointer;
    }

   #chat {
  max-width: 480px;
  margin: 0 auto;
  padding: 10px;
  padding-bottom: 80px;
  background-color: rgba(245, 245, 245, 0.2); /* â† é€éåº¦ã‚’å¤‰æ›´ */
  backdrop-filter: blur(4px); /* â† èƒŒæ™¯å‹•ç”»ã«ã¼ã‹ã—åŠ¹æœï¼ˆãŠå¥½ã¿ã§ï¼‰ */
  height: calc(100vh - 80px);
  overflow-y: auto;
  display: none;
  flex-direction: column;
  border-radius: 12px;
}


    .msg {
      max-width: 80%;
      margin: 6px;
      padding: 10px;
      border-radius: 18px;
      line-height: 1.4;
      word-wrap: break-word;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .left {
      align-self: flex-start;
      background-color: white;
      border-bottom-left-radius: 0;
    }

    .right {
      align-self: flex-end;
      background-color: #dcf8c6;
      border-bottom-right-radius: 0;
      flex-direction: row-reverse;
    }

    .icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
    }

    .name {
      font-size: 12px;
      margin: 4px;
      color: #666;
    }

    #controls {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: none;
      gap: 10px;
    }

    #controls button {
      background-color: #128C7E;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #gameOverScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      font-size: 24px;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #gameOverScreen button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 20px;
      background: #128C7E;
      color: white;
      cursor: pointer;
    }

    #imageModal {
      display: none;
      position: fixed;
      z-index: 99999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      justify-content: center;
      align-items: center;
    }

    #imageModal img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
      box-shadow: 0 0 20px #000;
      transition: transform 0.3s ease;
    }

    #imageModal:active img {
      transform: scale(1.01);
    }

#bgVideo {
  position: fixed;
  top: 0;
  left: 0;
  min-width: 100vw;
  min-height: 100vh;
  object-fit: cover;
  z-index: -1; /* èƒŒæ™¯ã¨ã—ã¦èƒŒé¢ã« */
}



  </style>
</head>
<body>

<video id="bgVideo" autoplay muted loop playsinline>
  <source src="bg.mp4" type="video/mp4">
  ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å‹•ç”»ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚
</video>


  <div id="titleScreen">
    <h1>ãƒ•ã‚©ãƒ“ã‚¢ãƒ»ãƒ‘ãƒ¼ãƒ†ã‚£</h1>
    <button onclick="startNew()">â–¶ æœ€åˆã‹ã‚‰</button>
  </div>

  <div id="chat"></div>

  <div id="controls">
    <button id="nextBtn">â–¶ æ¬¡ã¸</button>
    <button id="saveBtn">ğŸ’¾ ä¿å­˜</button>
    <button id="loadBtn">ğŸ“‚ èª­è¾¼</button>
  </div>

  <div id="gameOverScreen">
    <p>ğŸ’€ ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</p>
    <button onclick="returnToTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
  </div>

  <div id="imageModal" onclick="closeImageModal()">
    <img id="modalImg" src="" alt="æ‹¡å¤§ç”»åƒ">
  </div>

  <audio id="se" src="click.mp3" preload="auto"></audio>

  <script>
    const chat = document.getElementById("chat");
    const nextBtn = document.getElementById("nextBtn");
    const controls = document.getElementById("controls");
    const se = document.getElementById("se");
    const gameOverScreen = document.getElementById("gameOverScreen");
    const titleScreen = document.getElementById("titleScreen");

    const story = [
      { type: "msg", name: "ç™½é³¥", side: "left", icon: "shiratori.png", text: "åšå£«ãŒå€’ã‚ŒãŸã®ã¯ã‚ãªãŸã®ã›ã„â€¦é•ã„ã¾ã™ã‚ˆã­ï¼Ÿ" },
      {
        type: "choice",
        choices: [
          { text: "ãã‚“ãªã¯ãšãªã„", next: "deny", correct: true },
          { text: "â€¦â€¦ã‚‚ã—ã‹ã—ã¦", next: "admit", correct: false }
        ]
      },
      { id: "deny", type: "msg", name: "ã‚ãªãŸ", side: "right", icon: "you.png", text: "ãã‚“ãªã¯ãšã‚ã‚Šã¾ã›ã‚“ã€‚" },
      { id: "deny", type: "msg", name: "ç™½é³¥", side: "left", icon: "shiratori.png", text: "ãã†â€¦ä¿¡ã˜ã¦ã„ã¾ã™ã€‚" },
      { id: "deny", type: "image", src: "study.jpg", caption: "æ›¸æ–ã«ã‚ã£ãŸå¥‡å¦™ãªå†™çœŸ", side: "left", icon: "shiratori.png", name: "ç™½é³¥" },
      { id: "deny", type: "image", src: "study.jpg", caption: "ã‚ã‚ã‚ã‚", side: "left", icon: "you.png", name: "ã‚ãªãŸ" },
      { id: "deny", type: "msg", name: "ç™½é³¥", side: "left", icon: "shiratori.png", text: "ã¾ãšã¯æ‰‹ãŒã‹ã‚Šã‚’æ¢ã—ã¾ã—ã‚‡ã†ã€‚ã©ã“ã‹ã‚‰èª¿ã¹ã¾ã™ã‹ï¼Ÿ" },
      {
        type: "choice",
        choices: [
          { text: "æ›¸æ–ã‚’èª¿ã¹ã‚‹", next: "study", correct: true },
          { text: "ã‚­ãƒƒãƒãƒ³ã‚’èª¿ã¹ã‚‹", next: "kitchen", correct: false }
        ]
      },
      { id: "study", type: "msg", name: "ã‚ãªãŸ", side: "right", icon: "you.png", text: "æ›¸æ–ãŒæ€ªã—ã„æ°—ãŒã—ã¾ã™ã€‚" },
      { id: "study", type: "msg", name: "ç™½é³¥", side: "left", icon: "shiratori.png", text: "ã„ã„åˆ¤æ–­ã ã¨æ€ã„ã¾ã™ã€‚" },
      { id: "kitchen", type: "msg", name: "ã‚ãªãŸ", side: "right", icon: "you.png", text: "ã‚­ãƒƒãƒãƒ³ã‚’è¦‹ã¦ã¿ã¾ã™ã€‚" },
      { id: "kitchen", type: "msg", name: "ç™½é³¥", side: "left", icon: "shiratori.png", text: "â€¦ãã“ã¯é•ã†æ°—ãŒã™ã‚‹ã‘ã©ã€‚" }
    ];

    let index = 0;
    let currentBranch = null;
    let mistakeCount = 0;

    function addMessage(msg) {
      const msgEl = document.createElement("div");
      msgEl.classList.add("msg", msg.side);

      if (msg.type === "image") {
        msgEl.innerHTML = `
          <div class="icon" style="background-image: url('${msg.icon || 'shiratori.png'}')"></div>
          <div>
            <div class="name">${msg.name || "ç”»åƒ"}</div>
            <img src="${msg.src}" alt="${msg.caption || ''}" style="max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer;">
            ${msg.caption ? `<div style="font-size: 12px; color: #555; margin-top: 4px;">${msg.caption}</div>` : ""}
          </div>
        `;
      } else {
        msgEl.innerHTML = `
          <div class="icon" style="background-image: url('${msg.icon}')"></div>
          <div>
            <div class="name">${msg.name}</div>
            <div class="text"></div>
          </div>
        `;
      }

      chat.appendChild(msgEl);

      if (msg.type === "msg") {
        const textEl = msgEl.querySelector(".text");
        let i = 0;
        const interval = setInterval(() => {
          textEl.textContent += msg.text[i];
          i++;
          if (i >= msg.text.length) clearInterval(interval);
        }, 30);
        se.currentTime = 0;
        se.play();
        chat.scrollTop = chat.scrollHeight;
      }

      if (msg.type === "image") {
        const img = msgEl.querySelector("img");
        img.onload = () => {
          chat.scrollTop = chat.scrollHeight;
        };
        img.onclick = () => {
          document.getElementById("modalImg").src = img.src;
          document.getElementById("imageModal").style.display = "flex";
        };
      }
    }

   function showChoice(choices, isRestored = false) {
  nextBtn.style.display = "none";
  const choiceBox = document.createElement("div");
  choiceBox.id = "choiceBox";
  choiceBox.style.textAlign = "center";

  choices.forEach(choice => {
    const btn = document.createElement("button");
    btn.textContent = choice.text;
    btn.style.margin = "6px";
    btn.style.padding = "10px 20px";
    btn.style.borderRadius = "15px";
    btn.style.border = "none";
    btn.style.backgroundColor = "#128C7E";
    btn.style.color = "white";
    btn.style.fontSize = "16px";

    // é¸æŠè‚¢æƒ…å ±ã‚’å±æ€§ã¨ã—ã¦ä¿å­˜ï¼ˆã‚»ãƒ¼ãƒ–ç”¨ï¼‰
    btn.setAttribute("data-correct", choice.correct);
    btn.setAttribute("data-next", choice.next);

    btn.onclick = () => {
      if (choice.correct) {
        currentBranch = choice.next;
        chat.removeChild(choiceBox);
        nextBtn.style.display = "inline-block";
        nextStep();
      } else {
        mistakeCount++;
        chat.removeChild(choiceBox);
        addMessage({ type: "msg", name: "ã‚·ã‚¹ãƒ†ãƒ ", side: "left", icon: "warning.png", text: `ãã®é¸æŠè‚¢ã¯é•ã†ã‚ˆã†ã â€¦ï¼ˆãƒŸã‚¹${mistakeCount}å›ç›®ï¼‰` });
        if (mistakeCount >= 3) {
          setTimeout(() => showGameOver(), 1000);
        } else {
          setTimeout(() => showChoice(choices), 1000);
        }
      }
    };

    choiceBox.appendChild(btn);
  });

  chat.appendChild(choiceBox);
  chat.scrollTop = chat.scrollHeight;
}


    function nextStep() {
      while (index < story.length) {
        const item = story[index];
        if ((item.type === "msg" || item.type === "image") && (!item.id || item.id === currentBranch)) {
          addMessage(item);
          index++;
          break;
        }
        if (item.type === "choice") {
          showChoice(item.choices);
          index++;
          break;
        }
        index++;
      }
      if (index >= story.length) {
        nextBtn.disabled = true;
        nextBtn.innerText = "çµ‚ã‚ã‚Š";
      }
    }

    function startNew() {
      titleScreen.style.display = "none";
      gameOverScreen.style.display = "none";
      chat.style.display = "flex";
      controls.style.display = "flex";
      chat.innerHTML = "";
      index = 0;
      currentBranch = null;
      mistakeCount = 0;
      nextBtn.disabled = false;
      nextBtn.innerText = "â–¶ æ¬¡ã¸";
      nextBtn.style.display = "inline-block";
      const oldChoiceBox = document.getElementById("choiceBox");
      if (oldChoiceBox) oldChoiceBox.remove();
      nextStep();
    }

    function returnToTitle() {
      gameOverScreen.style.display = "none";
      chat.style.display = "none";
      controls.style.display = "none";
      titleScreen.style.display = "flex";
    }

    function startContinue() {
      startNew();
    }

    function showGameOver() {
      gameOverScreen.style.display = "flex";
      chat.style.display = "none";
      controls.style.display = "none";
      nextBtn.disabled = true;
    }

    function closeImageModal() {
      document.getElementById("imageModal").style.display = "none";
    }

    nextBtn.addEventListener("click", nextStep);

  // ã‚»ãƒ¼ãƒ–å‡¦ç†
 function saveGame() {
  const choiceBox = document.getElementById("choiceBox");
  let currentChoices = null;

  if (choiceBox) {
    currentChoices = Array.from(choiceBox.querySelectorAll("button")).map((btn, i) => {
      return {
        text: btn.textContent,
        correct: btn.getAttribute("data-correct") === "true",
        next: btn.getAttribute("data-next")
      };
    });
  }

  const saveData = {
    index,
    currentBranch,
    mistakeCount,
    chatHTML: chat.innerHTML,
    nextDisabled: nextBtn.disabled,
    nextText: nextBtn.innerText,
    currentChoices
  };
  localStorage.setItem("phobia_save", JSON.stringify(saveData));
  alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
}

function loadGame() {
  const data = localStorage.getItem("phobia_save");
  if (!data) {
    alert("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }

  const saveData = JSON.parse(data);
  titleScreen.style.display = "none";
  gameOverScreen.style.display = "none";
  chat.style.display = "flex";
  controls.style.display = "flex";

  index = saveData.index;
  currentBranch = saveData.currentBranch;
  mistakeCount = saveData.mistakeCount;
  chat.innerHTML = saveData.chatHTML;
  nextBtn.disabled = saveData.nextDisabled;
  nextBtn.innerText = saveData.nextText;
  nextBtn.style.display = nextBtn.disabled ? "none" : "inline-block";

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å†è¨­å®š
  document.querySelectorAll("#chat img").forEach(img => {
    img.onclick = () => {
      document.getElementById("modalImg").src = img.src;
      document.getElementById("imageModal").style.display = "flex";
    };
  });

  // é¸æŠè‚¢ã‚’å¾©å…ƒ
  const oldBox = document.getElementById("choiceBox");
  if (oldBox) oldBox.remove();

  if (saveData.currentChoices) {
    showChoice(saveData.currentChoices, true); // true = å¾©å…ƒãƒ¢ãƒ¼ãƒ‰
  }
}


  // ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
  document.getElementById("saveBtn").addEventListener("click", saveGame);
  document.getElementById("loadBtn").addEventListener("click", loadGame);

    
  </script>
</body>
</html>
